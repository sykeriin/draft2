<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroLish - Aviation Weather Made Simple</title>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            /* Light mode colors */
            --bg-light: #ffffff;
            --surface-light: #f8fafc;
            --text-light: #1e293b;
            --text-muted-light: #64748b;
            --border-light: #e2e8f0;
            --primary-light: #8b5cf6;
            --primary-hover-light: #7c3aed;
            --accent-light: #a855f7;
            
            /* Dark mode colors with green-yellow gradient */
            --bg-dark: #0f172a;
            --surface-dark: #1e293b;
            --text-dark: #f1f5f9;
            --text-muted-dark: #94a3b8;
            --border-dark: #334155;
            --primary-dark: #22c55e;
            --primary-hover-dark: #16a34a;
            --accent-dark: #eab308;
            
            /* Current theme */
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text: var(--text-light);
            --text-muted: var(--text-muted-light);
            --border: var(--border-light);
            --primary: var(--primary-light);
            --primary-hover: var(--primary-hover-light);
            --accent: var(--accent-light);
        }

        [data-theme="dark"] {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text: var(--text-dark);
            --text-muted: var(--text-muted-dark);
            --border: var(--border-dark);
            --primary: var(--primary-dark);
            --primary-hover: var(--primary-hover-dark);
            --accent: var(--accent-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            font-size: 14px;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            transform: translateY(-2px);
        }

        /* Search section */
        .search-section {
            background: linear-gradient(135deg, var(--surface), var(--bg));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 24px;
            align-items: center;
        }

        #airport-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        #airport-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .btn {
            padding: 16px 28px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            transform: translateY(-2px);
        }

        /* Data filters */
        .data-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-group:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .filter-group.active {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .filter-checkbox {
            margin: 0;
        }

        /* Main content grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
        }

        /* Weather briefing styles */
        .weather-briefing {
            min-height: 500px;
        }

        .airport-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .airport-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .airport-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .airport-name {
            font-weight: 600;
            font-size: 18px;
        }

        .severity-badge {
            padding: 6px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .severity-CLEAR {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .severity-MODERATE {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .severity-SEVERE {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .severity-UNKNOWN {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .weather-summary {
            margin-top: 16px;
            color: var(--text-muted);
            font-size: 15px;
            line-height: 1.6;
        }

        .ai-briefing {
            background: linear-gradient(135deg, var(--surface), var(--bg));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }

        .ai-section {
            margin-bottom: 20px;
        }

        .ai-section h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Raw data section */
        .raw-data-section {
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .raw-data-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .raw-data-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .raw-data-content {
            margin-top: 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .raw-data-content.expanded {
            max-height: 600px;
        }

        .raw-code {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 13px;
            margin-bottom: 12px;
            overflow-x: auto;
            line-height: 1.4;
        }

        /* Map styles */
        .map-container {
            min-height: 500px;
        }

        #weather-map {
            width: 100%;
            height: 500px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .map-controls {
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-info {
            color: var(--text-muted);
            font-size: 14px;
            padding: 12px 16px;
            background: var(--surface);
            border-radius: 10px;
            border: 1px solid var(--border);
            flex: 1;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status messages */
        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid;
            font-weight: 500;
        }

        .status-success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border-color: #22c55e;
        }

        .status-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border-color: #ef4444;
        }

        .status-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
            border-color: #3b82f6;
        }

        /* Dark theme status messages */
        [data-theme="dark"] .status-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: #4ade80;
            border-color: #22c55e;
        }

        [data-theme="dark"] .status-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #f87171;
            border-color: #ef4444;
        }

        [data-theme="dark"] .status-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: #60a5fa;
            border-color: #3b82f6;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .search-row {
                flex-direction: column;
            }

            #airport-input {
                width: 100%;
            }

            .data-filters {
                justify-content: center;
            }

            .header {
                flex-direction: column;
                gap: 20px;
            }

            .container {
                padding: 16px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">✈️ AeroLish</div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    🌙 Dark Mode
                </button>
                <button class="btn btn-secondary" onclick="checkServerHealth()">
                    📡 Server Status
                </button>
            </div>
        </header>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-row">
                <input 
                    type="text" 
                    id="airport-input" 
                    placeholder="Enter airport codes (e.g., KTUS or KLAX,KPHX,KSFO for route)"
                    onkeypress="handleEnterKey(event)"
                />
                <button class="btn btn-primary" onclick="analyzeWeather()">
                    🌤️ Analyze Weather
                </button>
            </div>

            <!-- Data Filters -->
            <div class="data-filters">
                <label class="filter-group active" data-filter="metar">
                    <input type="checkbox" class="filter-checkbox" checked style="display: none;"> METAR
                </label>
                <label class="filter-group active" data-filter="taf">
                    <input type="checkbox" class="filter-checkbox" checked style="display: none;"> TAF
                </label>
                <label class="filter-group" data-filter="pirep">
                    <input type="checkbox" class="filter-checkbox" style="display: none;"> PIREP
                </label>
                <label class="filter-group" data-filter="sigmet">
                    <input type="checkbox" class="filter-checkbox" style="display: none;"> SIGMET
                </label>
                <label class="filter-group" data-filter="airmet">
                    <input type="checkbox" class="filter-checkbox" style="display: none;"> AIRMET
                </label>
                <label class="filter-group" data-filter="winds_aloft">
                    <input type="checkbox" class="filter-checkbox" style="display: none;"> Winds Aloft
                </label>
                <label class="filter-group active" data-filter="ai">
                    <input type="checkbox" class="filter-checkbox" checked style="display: none;"> AI Analysis
                </label>
            </div>
        </section>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Weather Briefing Panel -->
            <div class="panel weather-briefing">
                <div class="panel-header">
                    <h2 class="panel-title">📋 Weather Briefing</h2>
                </div>
                <div id="briefing-content">
                    <div style="text-align: center; padding: 80px 20px; color: var(--text-muted);">
                        <div style="font-size: 64px; margin-bottom: 20px;">✈️</div>
                        <h3 style="margin-bottom: 12px;">Ready for Weather Analysis</h3>
                        <p>Enter airport codes above to get comprehensive weather briefings.</p>
                        <p style="margin-top: 8px; font-size: 14px;">Single airport: <code>KTUS</code> | Route: <code>KLAX,KPHX,KSFO</code></p>
                    </div>
                </div>
            </div>

            <!-- Map Panel -->
            <div class="panel map-container">
                <div class="panel-header">
                    <h2 class="panel-title">🗺️ Interactive Map</h2>
                </div>
                <div id="weather-map"></div>
                <div class="map-controls">
                    <div class="route-info" id="route-info">
                        Map will show airport locations and route weather conditions
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markers = [];
        let routeLine = null;
        let currentData = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupFilterListeners();
            checkServerHealth();
            
            // Load theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            setupInputHelpers();
        });

        // Setup input helpers
        function setupInputHelpers() {
            const input = document.getElementById('airport-input');
            
            input.addEventListener('input', function(e) {
                const value = e.target.value.trim();
                const codes = value.split(',').map(c => c.trim()).filter(c => c);
                
                if (value.includes(',')) {
                    updateRouteInfo(`Route Mode: ${codes.length} airports (${codes.join(' → ')})`);
                } else if (value.length > 0) {
                    updateRouteInfo('Single Airport Mode');
                } else {
                    updateRouteInfo('Map will show airport locations and route weather conditions');
                }
            });
        }

        function updateRouteInfo(text) {
            document.getElementById('route-info').textContent = text;
        }

        // Theme management
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const toggleBtn = document.querySelector('.theme-toggle');
            toggleBtn.textContent = theme === 'light' ? '🌙 Dark Mode' : '☀️ Light Mode';
        }

        // Map initialization
        function initializeMap() {
            map = L.map('weather-map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Filter management
        function setupFilterListeners() {
            document.querySelectorAll('.filter-group').forEach(group => {
                group.addEventListener('click', function() {
                    const checkbox = this.querySelector('.filter-checkbox');
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        this.classList.add('active');
                    } else {
                        this.classList.remove('active');
                    }
                });
            });
        }

        function getActiveFilters() {
            const active = {};
            document.querySelectorAll('.filter-group.active').forEach(group => {
                const filter = group.getAttribute('data-filter');
                active[filter] = true;
            });
            return active;
        }

        // Status message management
        function showStatus(message, type = 'info', duration = 5000) {
            const container = document.getElementById('status-container');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type} fade-in`;
            statusDiv.textContent = message;
            
            container.appendChild(statusDiv);
            
            if (duration > 0) {
                setTimeout(() => {
                    statusDiv.remove();
                }, duration);
            }
            
            return statusDiv;
        }

        // Server health check
        async function checkServerHealth() {
            try {
                console.log('Checking server health...');
                const response = await fetch('/health');
                console.log('Health response:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Health data:', data);
                    showStatus('✅ Server is healthy and ready', 'success', 3000);
                } else {
                    throw new Error(`Server returned ${response.status}`);
                }
            } catch (error) {
                console.error('Health check failed:', error);
                showStatus('❌ Cannot connect to server. Make sure Python backend is running on http://localhost:5000', 'error', 0);
            }
        }

        // Input handling
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                analyzeWeather();
            }
        }

        // Main weather analysis function
        async function analyzeWeather() {
            const input = document.getElementById('airport-input').value.trim();
            
            if (!input) {
                showStatus('Please enter airport codes (e.g., KTUS or KLAX,KPHX,KSFO)', 'error');
                return;
            }

            console.log('Input:', input);
            
            const airportCodes = input.split(',')
                .map(code => code.trim().toUpperCase())
                .filter(code => code.length > 0);
            
            console.log('Parsed codes:', airportCodes);
            
            if (airportCodes.length === 0) {
                showStatus('Please enter valid airport codes', 'error');
                return;
            }

            // Validate codes
            for (const code of airportCodes) {
                if (code.length < 3 || code.length > 4) {
                    showStatus(`Invalid airport code: ${code}. Use 3-4 letter codes.`, 'error');
                    return;
                }
            }

            const briefingContent = document.getElementById('briefing-content');
            briefingContent.classList.add('loading');
            
            const routeText = airportCodes.length === 1 ? 
                `single airport ${airportCodes[0]}` : 
                `route ${airportCodes.join(' → ')}`;
            
            const loadingStatus = showStatus(`🔄 Analyzing weather for ${routeText}...`, 'info', 0);
            
            try {
                let data;
                
                if (airportCodes.length === 1) {
                    console.log('Single airport mode');
                    data = await analyzeSingleAirport(airportCodes[0]);
                } else {
                    console.log('Route mode');
                    data = await analyzeRoute(airportCodes);
                }
                
                console.log('Analysis result:', data);
                
                currentData = data;
                displayWeatherData(data);
                updateMap(data);
                
                loadingStatus.remove();
                
                const successMessage = airportCodes.length === 1 ? 
                    `✅ Weather analysis complete for ${airportCodes[0]}` :
                    `✅ Route analysis complete for ${airportCodes.length} airports`;
                
                showStatus(successMessage, 'success');
                
            } catch (error) {
                console.error('Analysis failed:', error);
                loadingStatus.remove();
                showStatus(`❌ Analysis failed: ${error.message}`, 'error');
                
                briefingContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <h3>Analysis Failed</h3>
                        <p><strong>Input:</strong> ${input}</p>
                        <p><strong>Parsed as:</strong> ${airportCodes.join(', ')}</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <button class="btn btn-primary" onclick="analyzeWeather()" style="margin-top: 16px;">
                            Try Again
                        </button>
                    </div>
                `;
            } finally {
                briefingContent.classList.remove('loading');
            }
        }

        // Single airport analysis
        async function analyzeSingleAirport(icao) {
            console.log('Analyzing single airport:', icao);
            
            const url = `/api/weather/${icao}`;
            console.log('API call:', url);
            
            const response = await fetch(url);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const error = await response.json();
                    errorMessage = error.message || errorMessage;
                } catch {
                    errorMessage = `Server returned ${response.status}. Make sure backend is running.`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Single airport response:', data);
            return data;
        }

        // Route analysis
        async function analyzeRoute(airportCodes) {
            console.log('Analyzing route:', airportCodes);
            
            const url = `/api/route?airports=${encodeURIComponent(airportCodes.join(','))}`;
            console.log('Route API call:', url);
            
            const response = await fetch(url);
            console.log('Route response status:', response.status);
            
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const error = await response.json();
                    errorMessage = error.message || errorMessage;
                } catch {
                    errorMessage = `Server returned ${response.status}. Make sure backend is running.`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Route response:', data);
            return data;
        }

        // Display weather data
        function displayWeatherData(data) {
            const briefingContent = document.getElementById('briefing-content');
            
            if (data.icao) {
                displaySingleAirportData(data, briefingContent);
            } else if (data.route || data.analysis) {
                displayRouteData(data, briefingContent);
            } else {
                console.error('Unknown data format:', data);
                briefingContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <h3>Unknown Data Format</h3>
                        <p>Received unexpected data format from server.</p>
                    </div>
                `;
            }
        }

        function displaySingleAirportData(data, container) {
            const airport = data.airport;
            const weather = data.weather;
            const aiBriefing = data.ai_briefing;
            
            let html = `
                <div class="airport-card fade-in">
                    <div class="airport-header">
                        <div>
                            <div class="airport-name">${data.icao} - ${airport.name || 'Unknown Airport'}</div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                                ${airport.city || 'Unknown'}, ${airport.country || 'Unknown'}
                            </div>
                        </div>
                        <div class="severity-badge severity-${weather.metar?.parsed?.severity || 'UNKNOWN'}">
                            ${weather.metar?.parsed?.severity || 'UNKNOWN'}
                        </div>
                    </div>
                    
                    <div class="weather-summary">
                        <strong>Current conditions:</strong> ${weather.metar?.raw_text || 'No METAR data available'}
                    </div>
            `;
            
            // Add AI briefing if available
            if (aiBriefing && aiBriefing.executive_summary) {
                html += `
                    <div class="ai-briefing">
                        <div class="ai-section">
                            <h4>🤖 Executive Summary</h4>
                            <p>${aiBriefing.executive_summary}</p>
                        </div>
                `;
                
                if (aiBriefing.operational_impact) {
                    html += `
                        <div class="ai-section">
                            <h4>✈️ Operational Impact</h4>
                            <p>${aiBriefing.operational_impact}</p>
                        </div>
                    `;
                }
                
                if (aiBriefing.recommendations && Array.isArray(aiBriefing.recommendations)) {
                    html += `
                        <div class="ai-section">
                            <h4>💡 Recommendations</h4>
                            <ul>
                                ${aiBriefing.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            // Add raw data section
            html += createRawDataSection(weather, data.icao);
            html += '</div>';
            
            container.innerHTML = html;
        }

        function displayRouteData(data, container) {
            const route = data.route;
            const analysis = data.analysis;
            const aiBriefing = data.ai_briefing;
            
            let html = `
                <div class="fade-in">
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 12px;">Route Analysis: ${(route?.airports || []).join(' → ')}</h3>
                        <div class="severity-badge severity-${data.overall_conditions}">
                            Overall: ${data.overall_conditions}
                        </div>
                    </div>
            `;
            
            // Add AI briefing for route
            if (aiBriefing && aiBriefing.executive_summary) {
                html += `
                    <div class="ai-briefing" style="margin-bottom: 24px;">
                        <div class="ai-section">
                            <h4>🤖 Route Summary</h4>
                            <p>${aiBriefing.executive_summary}</p>
                        </div>
                    </div>
                `;
            }
            
            // Add airport cards for each airport in route
            if (analysis && analysis.airports) {
                analysis.airports.forEach(airportData => {
                    html += createAirportCard(airportData);
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function createAirportCard(airportData) {
            const airport = airportData.info;
            const weather = airportData.current_weather;
            const severity = weather?.parsed?.severity || 'UNKNOWN';
            
            return `
                <div class="airport-card">
                    <div class="airport-header">
                        <div>
                            <div class="airport-name">${airportData.code} - ${airport.name || 'Unknown Airport'}</div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                                ${airport.city || 'Unknown'}, ${airport.country || 'Unknown'}
                            </div>
                        </div>
                        <div class="severity-badge severity-${severity}">
                            ${severity}
                        </div>
                    </div>
                    
                    <div class="weather-summary">
                        <strong>Current:</strong> ${weather?.raw_text || 'No weather data available'}
                    </div>
                    
                    ${createRawDataSection(weather ? {metar: weather} : {}, airportData.code)}
                </div>
            `;
        }

        function createRawDataSection(weather, icao) {
            return `
                <div class="raw-data-section">
                    <button class="raw-data-toggle" onclick="toggleRawData('${icao}')">
                        📝 Show Raw Data
                    </button>
                    <div class="raw-data-content" id="raw-data-${icao}">
                        ${weather?.metar?.raw_text || weather?.raw_text ? `
                            <div>
                                <strong>METAR:</strong>
                                <div class="raw-code">${weather.metar?.raw_text || weather.raw_text || 'No METAR data'}</div>
                            </div>
                        ` : '<div class="raw-code">No METAR data available</div>'}
                        ${weather?.taf?.raw_text ? `
                            <div>
                                <strong>TAF:</strong>
                                <div class="raw-code">${weather.taf.raw_text}</div>
                            </div>
                        ` : '<div class="raw-code">No TAF data available</div>'}
                    </div>
                </div>
            `;
        }

        function toggleRawData(icao) {
            const content = document.getElementById(`raw-data-${icao}`);
            const button = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                button.textContent = '📝 Show Raw Data';
            } else {
                content.classList.add('expanded');
                button.textContent = '📝 Hide Raw Data';
            }
        }

        // Map management
        function updateMap(data) {
            clearMap();
            
            if (data.icao) {
                updateMapForSingleAirport(data);
            } else if (data.timeline) {
                updateMapForRoute(data);
            }
        }

        function clearMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        function updateMapForSingleAirport(data) {
            const airport = data.airport;
            
            if (airport.latitude && airport.longitude) {
                const severity = data.weather?.metar?.parsed?.severity || 'UNKNOWN';
                const color = getSeverityColor(severity);
                
                const marker = L.circleMarker([airport.latitude, airport.longitude], {
                    radius: 15,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindPopup(`
                    <div>
                        <strong>${data.icao} - ${airport.name}</strong><br>
                        <span style="color: ${color}; font-weight: bold;">${severity} conditions</span><br>
                        ${airport.city}, ${airport.country}
                    </div>
                `);
                
                markers.push(marker);
                map.setView([airport.latitude, airport.longitude], 10);
                
                document.getElementById('route-info').textContent = 
                    `📍 ${data.icao} - ${airport.name} | Conditions: ${severity}`;
            }
        }

        function updateMapForRoute(data) {
            const timeline = data.timeline;
            const validPoints = timeline.filter(point => point.latitude && point.longitude);
            
            if (validPoints.length === 0) return;
            
            // Create markers for each airport
            validPoints.forEach((point, index) => {
                const color = getSeverityColor(point.severity);
                
                const marker = L.circleMarker([point.latitude, point.longitude], {
                    radius: 12,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                const position = index === 0 ? '🛫 Departure' : 
                               index === validPoints.length - 1 ? '🛬 Arrival' : '📍 Waypoint';
                
                marker.bindPopup(`
                    <div>
                        <strong>${point.icao} - ${point.name}</strong><br>
                        <span style="color: ${color}; font-weight: bold;">${point.severity} conditions</span><br>
                        ${position}
                    </div>
                `);
                
                markers.push(marker);
            });
            
            // Create route line
            if (validPoints.length > 1) {
                const coordinates = validPoints.map(point => [point.latitude, point.longitude]);
                const worstSeverity = getWorstSeverity(validPoints.map(p => p.severity));
                const routeColor = getSeverityColor(worstSeverity);
                
                routeLine = L.polyline(coordinates, {
                    color: routeColor,
                    weight: 5,
                    opacity: 0.7
                }).addTo(map);
                
                map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
            }
            
            // Update route info
            const routeString = data.route?.airports?.join(' → ') || 'Unknown Route';
            document.getElementById('route-info').textContent = 
                `🛫 Route: ${routeString} | Overall: ${data.overall_conditions}`;
        }

        function getSeverityColor(severity) {
            const colors = {
                'SEVERE': '#dc2626',
                'MODERATE': '#f59e0b',
                'CLEAR': '#22c55e',
                'UNKNOWN': '#64748b'
            };
            return colors[severity] || colors.UNKNOWN;
        }

        function getWorstSeverity(severities) {
            if (severities.includes('SEVERE')) return 'SEVERE';
            if (severities.includes('MODERATE')) return 'MODERATE';
            if (severities.includes('CLEAR')) return 'CLEAR';
            return 'UNKNOWN';
        }
    </script>
</body>
</html>
